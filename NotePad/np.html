<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-Tab Notepad ‚Äî Avro Bengali</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f8fb;color:#222}
    header{background:linear-gradient(135deg,#4a90e2,#0078d7);color:#fff;padding:16px 20px;box-shadow:0 2px 8px rgba(0,0,0,.08);text-align:center}
    header .title{font-size:1.4rem;font-weight:700}
    header .meta{margin-top:4px;opacity:.95}
    .container{max-width:960px;margin:18px auto;background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 12px;border:1px solid #dcdfe6;background:#f3f5f9;border-radius:8px 8px 0 0;cursor:pointer}
    .tab.active{background:#fff;font-weight:600;border-bottom-color:#fff}
    textarea{width:100%;min-height:320px;padding:10px 12px;border:1px solid #dcdfe6;border-radius:10px;resize:vertical;font-size:16px;line-height:1.6}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:14px}
    .btn{background:#4a90e2;border:none;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn:hover{background:#0078d7}
    #cheatSheet{display:none;margin-top:14px;height:70vh;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
    #cheatSheet iframe{width:100%;height:100%;border:none}
  </style>
</head>
<body>

  <header>
    <div class="title">üìù Multi-Tab Notepad</div>
    <div class="meta"><span id="date"></span></div>
  </header>

  <div class="container">
    <div class="tabs" id="tabContainer"></div>

    <textarea id="noteArea" placeholder="Start typing... (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ: Avro ON / English: toggle)"></textarea>

    <div class="controls">
      <button class="btn" onclick="newTab()">‚ûï New Tab</button>
      <button class="btn" onclick="renameTab()">‚úèÔ∏è Rename Tab</button>
      <button class="btn" onclick="saveToFile()">üíæ Save to File</button>
      <button class="btn" id="avroToggle" onclick="toggleAvro()">üÖ±Ô∏è Bengali ON</button>
      <button class="btn" onclick="shareSelectedText()">Share Selected Text</button>
      <button class="btn" onclick="toggleCheatSheet()">üìñ Cheat Sheet (JPG)</button>
    </div>

    <!-- Cheat sheet JPG -->
    <div id="cheatSheet" style="max-height: 90vh; overflow-y: auto; border:1px solid #ccc; padding:5px;">
      <img src="cheatSheet.jpg"
           alt="ImageMagick Cheat Sheet"
           style="width:100%; height:auto; display:block; margin:auto;">
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Avro plugin (desktop) -->
  <script src="js/avro-v1.1.4.min.js"></script>
  <!-- Notepad logic -->
  <script src="js/notepad.js"></script>

  <script>
    // ---------- Date ----------
    function updateDate(){
      const now=new Date();
      const dd=String(now.getDate()).padStart(2,'0');
      const mm=String(now.getMonth()+1).padStart(2,'0');
      const yy=String(now.getFullYear()).slice(-2);
      const time=now.toLocaleTimeString();
      document.getElementById('date').textContent=`${dd}-${mm}-${yy} ${time}`;
    }
    setInterval(updateDate,1000); updateDate();

    // ---------- UI ----------
    function toggleCheatSheet(){
      const el=document.getElementById('cheatSheet');
      el.style.display = (el.style.display===''||el.style.display==='none') ? 'block':'none';
    }

    // ---------- Avro ----------
    const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
    const usePlugin = !isMobile;
    let avroEnabled = true;

    document.addEventListener('DOMContentLoaded', function(){
      if (usePlugin && avroEnabled && typeof $!=='undefined' && typeof $.fn.avro==='function'){
        $('#noteArea').avro();
      }
      enableAvroMobilePatch();
    });

    function toggleAvro(){
      const oldArea=document.getElementById('noteArea');
      const clone=oldArea.cloneNode(true);
      clone.value=oldArea.value;
      oldArea.parentNode.replaceChild(clone, oldArea);

      avroEnabled = !avroEnabled;
      document.getElementById('avroToggle').textContent = avroEnabled ? 'üÖ±Ô∏è Bengali ON' : 'üî§ English ON';

      if (avroEnabled && usePlugin && typeof $!=='undefined' && typeof $.fn.avro==='function'){
        $('#noteArea').avro();
      }
      enableAvroMobilePatch();
    }

    document.addEventListener('keydown', function(e){
      if (e.ctrlKey && e.key==='m'){ e.preventDefault(); toggleAvro(); }
    });

    // ---------- Fixed Mobile Patch ----------
    function enableAvroMobilePatch() {
      const area = document.getElementById('noteArea');
      if (!area || usePlugin || area.dataset.avroPatched === '1') return;

      function convertLastAsciiWord(str) {
        const m = str.match(/([A-Za-z']+)(\s*)$/);
        if (!m) return str;
        const word = m[1];
        const trail = m[2];
        const start = str.length - (word.length + trail.length);
        const converted = (typeof Avro !== 'undefined' && Avro.Phonetic && Avro.Phonetic.parse)
          ? Avro.Phonetic.parse(word) : word;
        return str.slice(0, start) + converted + trail;
      }

      function handleTransliteration() {
        if (!avroEnabled) return;
        const pos = area.selectionStart;
        const val = area.value;
        const before = val.slice(0, pos);
        const after = val.slice(pos);

        const lastChar = before.slice(-1);
        if (lastChar === ' ' || lastChar === '\n') {
          const newBefore = convertLastAsciiWord(before);
          if (newBefore !== before) {
            area.value = newBefore + after;
            const newPos = newBefore.length;
            area.selectionStart = area.selectionEnd = newPos;
          }
        }
      }

      area.addEventListener('input', handleTransliteration);
      area.addEventListener('compositionend', handleTransliteration);

      area.dataset.avroPatched = '1';
    }

    // ---------- Share Selected Text ----------
    function shareSelectedText() {
      const textarea = document.getElementById('noteArea');
      const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);

      if (!selectedText) {
        alert("Please select some text first.");
        return;
      }

      if (navigator.share) {
        navigator.share({
          title: 'Shared from Multi-Tab Notepad',
          text: selectedText
        }).catch(err => {
          console.error("Error sharing: ", err);
        });
      } else {
        alert("Sharing not supported in this browser. Please copy instead.");
      }
    }

    // ---------- Dummy tab actions ----------
    function newTab(){ alert('New Tab'); }
    function renameTab(){ alert('Rename Tab'); }
    function saveToFile(){ 
      const text=document.getElementById('noteArea').value||'';
      const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='note.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
